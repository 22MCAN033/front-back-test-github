name: Two-Branch CI/CD Pipeline - Frontend & Backend

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  setup:
    name: Determine Environment & Configuration
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      backend_port: ${{ steps.config.outputs.backend_port }}
      frontend_port: ${{ steps.config.outputs.frontend_port }}
      container_prefix: ${{ steps.config.outputs.container_prefix }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "backend_port=${{ secrets.PROD_BACKEND_PORT }}" >> $GITHUB_OUTPUT
            echo "frontend_port=${{ secrets.PROD_FRONTEND_PORT }}" >> $GITHUB_OUTPUT
            echo "container_prefix=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "backend_port=${{ secrets.DEV_BACKEND_PORT }}" >> $GITHUB_OUTPUT
            echo "frontend_port=${{ secrets.DEV_FRONTEND_PORT }}" >> $GITHUB_OUTPUT
            echo "container_prefix=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=unknown" >> $GITHUB_OUTPUT
            echo "backend_port=0" >> $GITHUB_OUTPUT
            echo "frontend_port=0" >> $GITHUB_OUTPUT
            echo "container_prefix=unknown" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Docker Images on EC2
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Fetch EC2 SSH Key
        id: fetch_ssh
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "vaibhav/dev/secret" \
            --query SecretString \
            --output text)
          echo "$SECRET_JSON" | jq -r '.EC2_SSH_KEY' | sed 's/\\n/\n/g' > $RUNNER_TEMP/ssh_key.pem
          chmod 600 $RUNNER_TEMP/ssh_key.pem
          echo "SSH_KEY<<EOF" >> $GITHUB_ENV
          cat $RUNNER_TEMP/ssh_key.pem >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Source Code to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ env.SSH_KEY }}
          source: "."
          target: "/home/ubuntu/app-${{ needs.setup.outputs.container_prefix }}"
          rm: true
          overwrite: true

      - name: Build Docker Images on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            set -ex
            APP_DIR=/home/ubuntu/app-${{ needs.setup.outputs.container_prefix }}
            cd $APP_DIR

            BUILD_TAG="${{ needs.setup.outputs.container_prefix }}-${{ github.run_id }}"
            BUILD_TIMESTAMP=$(date +%Y%m%d%H%M%S)
            ENVIRONMENT="${{ needs.setup.outputs.environment }}"

            # Write build_tag and environment inside the app directory
            echo "${BUILD_TAG}" > $APP_DIR/build_tag_${{ needs.setup.outputs.container_prefix }}.txt
            echo "${ENVIRONMENT}" > $APP_DIR/environment_${{ needs.setup.outputs.container_prefix }}.txt

            echo "ðŸ—ï¸ Building Backend..."
            sudo docker build --no-cache --build-arg BUILD_TIMESTAMP=${BUILD_TIMESTAMP} --build-arg ENVIRONMENT=${ENVIRONMENT} -t backend-app:${BUILD_TAG} .

            echo "ðŸ—ï¸ Building Frontend..."
            cd frontend
            sudo docker build --no-cache --build-arg BUILD_TIMESTAMP=${BUILD_TIMESTAMP} --build-arg ENVIRONMENT=${ENVIRONMENT} -t frontend-app:${BUILD_TAG} .

  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.environment != 'unknown'
    environment:
      name: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1
  
      - name: Fetch EC2 SSH Key
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "vaibhav/dev/secret" \
            --region eu-north-1 \
            --query SecretString \
            --output text)
          echo "$SECRET_JSON" | jq -r '.EC2_SSH_KEY' | sed 's/\\n/\n/g' > $RUNNER_TEMP/ssh_key.pem
          chmod 600 $RUNNER_TEMP/ssh_key.pem
          echo "SSH_KEY<<EOF" >> $GITHUB_ENV
          cat $RUNNER_TEMP/ssh_key.pem >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
  
      - name: Deploy Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ env.SSH_KEY }}
          envs: GITHUB_REF_NAME   # ðŸ‘ˆ pass branch name into EC2
          script: |
            set -ex
            APP_DIR=/home/ubuntu/app-${{ needs.setup.outputs.container_prefix }}
            CONTAINER_PREFIX=${{ needs.setup.outputs.container_prefix }}
      
            BUILD_TAG=$(cat $APP_DIR/build_tag_${CONTAINER_PREFIX}.txt)
            ENVIRONMENT="${{ needs.setup.outputs.environment }}"
      
            echo "Branch detected: ${GITHUB_REF_NAME}"
      
            # Branch based ports
            if [ "${GITHUB_REF_NAME}" = "main" ]; then
              export BACKEND_PORT=${{ secrets.PROD_BACKEND_PORT }}
              export FRONTEND_PORT=${{ secrets.PROD_FRONTEND_PORT }}
            elif [ "${GITHUB_REF_NAME}" = "dev" ]; then
              export BACKEND_PORT=${{ secrets.DEV_BACKEND_PORT }}
              export FRONTEND_PORT=${{ secrets.DEV_FRONTEND_PORT }}
            else
              echo "âŒ Unknown branch: ${GITHUB_REF_NAME}"
              exit 1
            fi
      
            echo "ðŸš€ Deploying containers on ports Backend:${BACKEND_PORT} Frontend:${FRONTEND_PORT}..."
      
            # Backend
            sudo docker stop ${CONTAINER_PREFIX}-backend || true
            sudo docker rm ${CONTAINER_PREFIX}-backend || true
            sudo docker run -d -p ${BACKEND_PORT}:5000 \
              --name ${CONTAINER_PREFIX}-backend \
              --restart unless-stopped \
              -e NODE_ENV=${ENVIRONMENT} \
              backend-app:${BUILD_TAG}
      
            # Frontend
            sudo docker stop ${CONTAINER_PREFIX}-frontend || true
            sudo docker rm ${CONTAINER_PREFIX}-frontend || true
            sudo docker run -d -p ${FRONTEND_PORT}:80 \
              --name ${CONTAINER_PREFIX}-frontend \
              --restart unless-stopped \
              -e ENVIRONMENT=${ENVIRONMENT} \
              frontend-app:${BUILD_TAG}


  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always()
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Fetch EC2 SSH Key
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "vaibhav/dev/secret" \
            --region eu-north-1 \
            --query SecretString \
            --output text)
          echo "$SECRET_JSON" | jq -r '.EC2_SSH_KEY' | sed 's/\\n/\n/g' > $RUNNER_TEMP/ssh_key.pem
          chmod 600 $RUNNER_TEMP/ssh_key.pem
          echo "SSH_KEY<<EOF" >> $GITHUB_ENV
          cat $RUNNER_TEMP/ssh_key.pem >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Cleanup Docker Images
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "ðŸ§¹ Cleaning up old Docker images..."
            # Backend - dev
            sudo docker images backend-app --format "{{.Tag}}" | grep '^dev-' | tail -n +3 | xargs -r -I {} sudo docker rmi backend-app:{} || true
            
            # Backend - prod
            sudo docker images backend-app --format "{{.Tag}}" | grep '^prod-' | tail -n +3 | xargs -r -I {} sudo docker rmi backend-app:{} || true
            
            # Frontend - dev
            sudo docker images frontend-app --format "{{.Tag}}" | grep '^dev-' | tail -n +3 | xargs -r -I {} sudo docker rmi frontend-app:{} || true
            
            # Frontend - prod
            sudo docker images frontend-app --format "{{.Tag}}" | grep '^prod-' | tail -n +3 | xargs -r -I {} sudo docker rmi frontend-app:{} || true
            echo "âœ… Cleanup completed!"


  notify:
    name: Send Deployment Completion Email
    runs-on: ubuntu-latest
    needs: cleanup
    if: always()
    steps:
      - name: Set Email Content
        id: email_content
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
  
          if [[ "$BRANCH_NAME" == "main" ]]; then
            SUBJECT="âœ… CI/CD Deployment Completed - PRODUCTION"
            BODY="Hi Team,\n\nThe CI/CD pipeline for branch **main** has successfully completed.\n\nEnvironment: production\nBackend Port: ${{ needs.setup.outputs.backend_port }}\nFrontend Port: ${{ needs.setup.outputs.frontend_port }}\nContainer Prefix: prod\n\nBuild & Deployment Details:\n- Backend Docker Tag: ${{ needs.build.outputs.backend_tag || 'N/A' }}\n- Frontend Docker Tag: ${{ needs.build.outputs.frontend_tag || 'N/A' }}\n\nBest,\nGitHub Actions"
          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            SUBJECT="âœ… CI/CD Deployment Completed - DEVELOPMENT"
            BODY="Hi Team,\n\nThe CI/CD pipeline for branch **dev** has successfully completed.\n\nEnvironment: development\nBackend Port: ${{ needs.setup.outputs.backend_port }}\nFrontend Port: ${{ needs.setup.outputs.frontend_port }}\nContainer Prefix: dev\n\nBuild & Deployment Details:\n- Backend Docker Tag: ${{ needs.build.outputs.backend_tag || 'N/A' }}\n- Frontend Docker Tag: ${{ needs.build.outputs.frontend_tag || 'N/A' }}\n\nBest,\nGitHub Actions"
          else
            SUBJECT="âš ï¸ CI/CD Deployment Completed - UNKNOWN BRANCH"
            BODY="Hi Team,\n\nThe CI/CD pipeline ran on an unknown branch: $BRANCH_NAME.\n\nBest,\nGitHub Actions"
          fi
  
          echo "SUBJECT=${SUBJECT}" >> $GITHUB_ENV
          echo "BODY=${BODY}" >> $GITHUB_ENV
  
      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ env.SUBJECT }}
          body: ${{ env.BODY }}
          to: "team@example.com"
          from: "GitHub Actions <${{ secrets.EMAIL_USER }}>"
          secure: true
