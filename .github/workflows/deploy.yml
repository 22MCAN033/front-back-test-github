name: Two-Branch CI/CD Pipeline - Frontend & Backend

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  setup:
    name: Determine Environment & Configuration
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      backend_port: ${{ steps.config.outputs.backend_port }}
      frontend_port: ${{ steps.config.outputs.frontend_port }}
      container_prefix: ${{ steps.config.outputs.container_prefix }}
    steps:
      - name: Set Environment Configuration
        id: config
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "backend_port=${{ secrets.BACKEND_PORT }}" >> $GITHUB_OUTPUT
            echo "frontend_port=${{ secrets.FRONTEND_PORT }}" >> $GITHUB_OUTPUT
            echo "container_prefix=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "backend_port=${{ secrets.BACKEND_PORT }}" >> $GITHUB_OUTPUT
            echo "frontend_port=${{ secrets.FRONTEND_PORT }}" >> $GITHUB_OUTPUT
            echo "container_prefix=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=unknown" >> $GITHUB_OUTPUT
            echo "backend_port=0" >> $GITHUB_OUTPUT
            echo "frontend_port=0" >> $GITHUB_OUTPUT
            echo "container_prefix=unknown" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Docker Images on EC2
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Fetch EC2 SSH Key from Secrets Manager
        id: fetch_ssh
        run: |
          echo "ðŸ”‘ Fetching EC2 SSH Key..."
          
          # Get the secret and extract SSH key with proper newline handling
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "vaibhav-secret" \
            --query SecretString \
            --output text)
          
          # Extract SSH key and handle newlines properly  
          echo "$SECRET_JSON" | jq -r '.EC2_SSH_KEY' | sed 's/\\n/\n/g' > $HOME/ssh_key.pem
          chmod 600 $HOME/ssh_key.pem
          
          # Verify the key format
          echo "âœ… SSH key saved to $HOME/ssh_key.pem"
          head -1 $HOME/ssh_key.pem
          tail -1 $HOME/ssh_key.pem

      - name: Set Build Variables
        id: vars
        run: |
          BUILD_TAG="${{ needs.setup.outputs.container_prefix }}-${{ github.run_id }}"
          BUILD_TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "BUILD_TAG=${BUILD_TAG}" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}" >> $GITHUB_ENV

      - name: Send Source Code to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: $HOME/ssh_key.pem
          source: "."
          target: "/home/ubuntu/app-${{ needs.setup.outputs.container_prefix }}"
          rm: true
          overwrite: true
          debug: true

      - name: Build Docker Images on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: $HOME/ssh_key.pem
          script: |
            set -ex
            cd /home/ubuntu/app-${{ needs.setup.outputs.container_prefix }}
            BUILD_TAG="${{ env.BUILD_TAG }}"
            BUILD_TIMESTAMP="${{ env.BUILD_TIMESTAMP }}"
            ENVIRONMENT="${{ needs.setup.outputs.environment }}"

            # Store build info for deploy stage
            echo "${BUILD_TAG}" > ~/build_tag_${{ needs.setup.outputs.container_prefix }}.txt
            echo "${ENVIRONMENT}" > ~/environment_${{ needs.setup.outputs.container_prefix }}.txt

            echo "ðŸ—ï¸  Building Backend..."
            cd backend
            sudo docker build --no-cache --build-arg BUILD_TIMESTAMP=${BUILD_TIMESTAMP} --build-arg ENVIRONMENT=${ENVIRONMENT} -t backend-app:${BUILD_TAG} .

            echo "ðŸ—ï¸  Building Frontend..."
            cd ../frontend
            sudo docker build --no-cache --build-arg BUILD_TIMESTAMP=${BUILD_TIMESTAMP} --build-arg ENVIRONMENT=${ENVIRONMENT} -t frontend-app:${BUILD_TAG} .

            echo "âœ… Build completed"

  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.environment != 'unknown'
    environment:
      name: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Fetch EC2 SSH Key for Deploy
        run: |
          echo "ðŸ”‘ Fetching EC2 SSH Key for deployment..."
          
          # Get the secret and extract SSH key with proper newline handling
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "vaibhav-secret" \
            --query SecretString \
            --output text)
          
          # Extract SSH key and handle newlines properly
          echo "$SECRET_JSON" | jq -r '.EC2_SSH_KEY' | sed 's/\\n/\n/g' > $HOME/ssh_key.pem
          chmod 600 $HOME/ssh_key.pem
          
          echo "âœ… SSH key ready for deployment"

      - name: Deploy Containers on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: $HOME/ssh_key.pem
          script: |
            set -ex
            BUILD_TAG=$(cat ~/build_tag_${{ needs.setup.outputs.container_prefix }}.txt)
            ENVIRONMENT=$(cat ~/environment_${{ needs.setup.outputs.container_prefix }}.txt)
            CONTAINER_PREFIX="${{ needs.setup.outputs.container_prefix }}"
            BACKEND_PORT="${{ secrets.BACKEND_PORT }}"
            FRONTEND_PORT="${{ secrets.FRONTEND_PORT }}"

            echo "ðŸš€ Deploying ${ENVIRONMENT} environment"
            echo "Build Tag: ${BUILD_TAG}"
            echo "Container Prefix: ${CONTAINER_PREFIX}"

            # Backend Deployment
            echo "Deploying Backend..."
            sudo docker stop ${CONTAINER_PREFIX}-backend || true
            sudo docker rm ${CONTAINER_PREFIX}-backend || true
            sudo docker run -d -p ${BACKEND_PORT}:5000 --name ${CONTAINER_PREFIX}-backend --restart unless-stopped -e NODE_ENV=${ENVIRONMENT} backend-app:${BUILD_TAG}
            sleep 10

            # Frontend Deployment  
            echo "Deploying Frontend..."
            sudo docker stop ${CONTAINER_PREFIX}-frontend || true
            sudo docker rm ${CONTAINER_PREFIX}-frontend || true
            sudo docker run -d -p ${FRONTEND_PORT}:80 --name ${CONTAINER_PREFIX}-frontend --restart unless-stopped -e ENVIRONMENT=${ENVIRONMENT} frontend-app:${BUILD_TAG}
            sleep 10

            # Verification
            echo "Verifying deployments..."
            sudo docker ps | grep ${CONTAINER_PREFIX}

            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "Backend running on port: ${BACKEND_PORT}"
            echo "Frontend running on port: ${FRONTEND_PORT}"
